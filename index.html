<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SpeedRead Trainer V2</title>
  <link rel="stylesheet" href="./app.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">SR</div>
      <div class="brand-text">
        <div class="brand-title">SpeedRead Trainer</div>
        <div class="brand-subtitle">V2 • Local + Sync • IT/EN</div>
      </div>
    </div>

    <div class="topbar-actions">
      <label class="field compact">
        <span>Utente</span>
        <select id="userSelect"></select>
      </label>
      <button class="btn" id="btnAddUser">+ Nuovo</button>
      <button class="btn secondary" id="btnSettings">Impostazioni</button>
    </div>
  </header>

  <main class="layout">
    <aside class="dashboard-ribbon">
      <nav class="nav">
        <button class="nav-item active" data-view="dashboard">Dashboard</button>
        <button class="nav-item" data-view="reader">Lettura veloce</button>
        <button class="nav-item" data-view="span">Campo visivo</button>
        <button class="nav-item" data-view="fixation">Punti di fissità</button>
        <button class="nav-item" data-view="data">Dati</button>
        <button class="nav-item" data-view="help">Guida</button>
      </nav>

      <section class="card mini">
        <div class="card-title">Obiettivo</div>
        <div class="muted" id="goalLine">—</div>
        <div class="muted small" id="levelLine">—</div>
      </section>

      <section class="card mini">
        <div class="card-title">Testo</div>
        <div class="muted small" id="textMeta">—</div>
        <div class="row gap">
          <button class="btn secondary small" id="btnNewText">Nuovo testo</button>
          <button class="btn secondary small" id="btnCopyText">Copia</button>
        </div>
      </section>
    </aside>

    <section class="content">
      <div class="grid">
        <!-- Dashboard -->
        <section class="card view" data-view="dashboard">
          <div class="card-head">
            <h2>Dashboard</h2>
            <div class="row gap">
              <button class="btn secondary" id="btnQuickStart">Avvia lettura</button>
              <button class="btn secondary" id="btnExport">Esporta</button>
              <button class="btn secondary" id="btnImport">Importa</button>
            <div class="badge" id="fixWpm">— WPM</div>
            </div>
            <div></div>
          </div>
          <div class="card-body exercise-body">
            <div class="exercise-layout">
              <div class="card inner">
                <div class="card-title">Velocità (WPM) — Lettura</div>
                <div id="chartWpm" class="chart"></div>
              </div>
              <div class="card inner">
                <div class="card-title">Accuratezza — Tutti gli esercizi</div>
                <div id="chartAcc" class="chart"></div>
              </div>
            </div>

            <div class="card inner" style="margin-top: 12px;">
              <div class="card-title">Ultime sessioni</div>
              <div id="recentSessions" class="list"></div>
            </div>
          </div>
        </section>

        <!-- Reader -->
        <section class="card view hidden" data-view="reader">
          <div class="card-head">
            <h2>Lettura veloce</h2>
            <div class="row gap">
              <button class="btn" id="btnReaderStart">Start</button>
              <button class="btn secondary" id="btnReaderPause">Pausa</button>
              <button class="btn danger" id="btnReaderStop">Stop</button>
            </div>
          </div>

          <div class="card-body exercise-body">
            <div class="exercise-layout">
              <div class="card inner settings-panel">
                <div class="card-title">Impostazioni</div>

                <div class="grid-2 tight">
                  <label class="field">
                    <span>Lingua</span>
                    <select id="readerLang">
                      <option value="it">Italiano</option>
                      <option value="en">English</option>
                    </select>
                  </label>

                  <label class="field">
                    <span>Modalità</span>
                    <select id="readerMode">
                      <option value="rsvp">RSVP (una parola)</option>
                      <option value="chunk">Chunking (gruppi)</option>
                      <option value="pacer">Pacer (testo + evidenzia)</option>
                    </select>
                  </label>

                  <label class="field">
                    <span>WPM</span>
                    <input id="readerWpm" type="number" min="50" max="2500" step="10" value="350" />
                  </label>

                  <label class="field">
                    <span>Chunk (parole)</span>
                    <input id="readerChunk" type="number" min="1" max="12" step="1" value="3" />
                  </label>

                  <label class="field">
                    <span>Parole target (min)</span>
                    <input id="readerMinWords" type="number" min="60" max="2000" step="20" value="180" />
                  </label>

                  <label class="field">
                    <span>Sorgente</span>
                    <select id="readerSource">
                      <option value="wiki">Wikipedia (random)</option>
                      <option value="offline">Offline (fallback)</option>
                      <option value="custom">Testo incollato</option>
                    </select>
                  </label>

                  <label class="field grid-span-2">
                    <span>Testo personalizzato (incolla da editor)</span>
                    <textarea id="readerCustomText" rows="5" placeholder="Incolla qui il tuo testo..."></textarea>
                  </label>
                </div>

                <div class="row gap" style="margin-top: 10px;">
                  <button class="btn secondary" id="btnLoadText">Carica testo</button>
                  <div class="muted small" id="readerStatus">—</div>
                </div>
              </div>

              <div class="card inner display-panel">
                <div class="card-title">Display</div>
                <div id="readerDisplay" class="reader-display" aria-live="polite"></div>
                <div id="pacerBox" class="pacer-box hidden"></div>

                <div class="row between" style="margin-top: 10px;">
                  <div class="muted small" id="readerTimer">0:00</div>
                  <div class="muted small" id="readerProgress">—</div>
                </div>
              </div>
            </div>

            <div class="card inner" style="margin-top: 12px;">
              <div class="card-title">Quiz (riconoscimento parole)</div>
              <div id="quizBox" class="quiz"></div>
            </div>
          </div>
        </section>

        <!-- Span -->
        <section class="card view hidden" data-view="span">
          <div class="card-head">
            <h2>Ampliamento campo visivo</h2>
            <div class="row gap">
              <button class="btn" id="btnSpanNew" type="button">Nuova prova</button>
              <button class="btn secondary" id="btnSpanCheck" type="button">Verifica</button>
              <button class="btn danger" id="btnSpanEnd" type="button">Fine sessione</button>
            </div>
          </div>

          <div class="card-body exercise-body">
            <div class="exercise-layout">
              <div class="card inner settings-panel">
                <div class="card-title">Impostazioni automatiche</div>

                <div class="grid-2 tight">
                  <label class="field">
                    <span>Millisecondi</span>
                    <input id="spanMs" type="number" min="40" max="3000" step="10" value="800" />
                  </label>
                  <label class="field">
                    <span>Font (%)</span>
                    <input id="spanFont" type="number" min="70" max="220" step="10" value="110" />
                  </label>
                </div>

                <div id="spanStatus" class="muted small" style="margin-top: 10px;">Livello: Stage 1 · 4 caratteri</div>
                <div class="muted small" id="spanScore" style="margin-top: 6px;">Score: 0/0</div>
              </div>

              <div class="card inner display-panel">
                <div class="card-title">Prova</div>
                <div class="span-box">
                  <div id="spanStimulus" class="span-stimulus" aria-live="polite">—</div>
                  <div class="muted small" style="text-align:center;">^</div>
                  <div class="row gap center" style="margin-top: 10px;">
                    <input id="spanInput" class="text-input" autocomplete="off" placeholder="digita qui…" />
                  </div>
                  <div id="spanResult" class="muted" style="text-align:center; margin-top: 8px;"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Fixation -->
        <section class="card view hidden" data-view="fixation">
          <div class="card-head fixation-head">
            <h2>Punti di fissità</h2>
            <div class="row gap fixation-actions">
              <button class="btn" id="btnFixStart" type="button">Start</button>
              <button class="btn secondary" id="btnFixPause" type="button">Pausa</button>
              <button class="btn danger" id="btnFixStop" type="button">Stop</button>
              <div class="badge" id="fixWpm">— WPM</div>
            </div>
            <div></div>
          </div>

          <div class="card-body exercise-body">
            <div class="exercise-layout fixation-layout">
              <div class="card inner settings-panel narrow">
                <div class="card-title">Impostazioni (10%)</div>
                <div class="tight stack-fields">
                  <label class="field">
                    <span>Millisecondi</span>
                    <input id="fixMs" type="number" min="50" max="3000" step="10" value="250" />
                  </label>

                  <label class="field">
                    <span>Giri</span>
                    <input id="fixLaps" type="number" min="1" max="20" step="1" value="2" />
                  </label>

                  <label class="field">
                    <span>Punti per riga</span>
                    <select id="fixCols">
                      <option value="2">2</option>
                      <option value="3" selected>3</option>
                      <option value="4">4</option>
                    </select>
                  </label>

                  <label class="field">
                    <span>Righe</span>
                    <input id="fixRows" type="number" min="4" max="250" step="1" value="10" />
                  </label>

                  <label class="field">
                    <span>Modalità</span>
                    <select id="fixMode">
                      <option value="dots">Solo punti</option>
                      <option value="text">Punti + testo</option>
                    </select>
                  </label>

                  <label class="field">
                    <span>Segmento (caratteri)</span>
                    <input id="fixSegLen" type="number" min="10" max="60" step="2" value="20" />
                  </label>

                  <label class="field">
                    <span>Lingua testo</span>
                    <select id="fixLang">
                      <option value="it" selected>Italiano</option>
                      <option value="en">English</option>
                    </select>
                  </label>

                  <label class="field">
                    <span>Sorgente testo</span>
                    <select id="fixSource">
                      <option value="wiki">Wikipedia (random)</option>
                      <option value="offline">Offline (fallback)</option>
                      <option value="custom">Testo incollato</option>
                    </select>
                  </label>

                  <label class="field grid-span-2">
                    <span>Testo personalizzato (incolla da editor)</span>
                    <textarea id="fixCustomText" rows="4" placeholder="Incolla qui il tuo testo..."></textarea>
                  </label>
                </div>

                <div class="row gap" style="margin-top: 10px;">
                  <button class="btn secondary" id="btnFixLoadText">Carica testo</button>
                  <div class="muted small" id="fixStatus">—</div>
                </div>
              </div>

              <div class="card inner display-panel">
                <div class="card-title">Esercizio (90%)</div>
                <div id="fixGrid" class="fix-grid" aria-live="polite"></div>
                <div class="row between" style="margin-top: 10px;">
                  <div class="muted small" id="fixTimer">0:00</div>
                  <div class="muted small" id="fixProgress">—</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Data -->
        <section class="card view hidden" data-view="data">
          <div class="card-head">
            <h2>Dati</h2>
            <div class="row gap">
              <button class="btn secondary" id="btnWipeUser">Azzera utente</button>
              <button class="btn danger" id="btnWipeAll">Azzera tutto</button>
            </div>
          </div>
          <div class="card-body">
            <div class="muted">Qui vedi un dump JSON dei dati dell'utente corrente (utile per debug).</div>
            <pre id="dataDump" class="code"></pre>
          </div>
        </section>

        <!-- Help -->
        <section class="card view hidden" data-view="help">
          <div class="card-head">
            <h2>Guida rapida</h2>
            <div class="row gap">
              <button class="btn secondary" id="btnOpenSync">Configura Sync</button>
            </div>
          </div>
          <div class="card-body prose">
            <h3>1) Avvio in locale</h3>
            <ol>
              <li>Crea una cartella (es. <code>speedread</code>) e mettici i 3 file: <code>index.html</code>, <code>app.css</code>, <code>app.js</code>.</li>
              <li>Apri <b>PowerShell</b> o <b>Prompt dei comandi</b> nella cartella.</li>
              <li>Esegui: <code>python -m http.server 8080</code></li>
              <li>Apri Brave su <code>http://localhost:8080</code></li>
            </ol>

            <h3>2) Sync (Local + Sync)</h3>
            <p>
              Il metodo più robusto senza server è usare un <b>file JSON</b> in una cartella sincronizzata (Nextcloud/Dropbox ecc.).
              Clicca <b>Configura Sync</b>, scegli un file (es. <code>speedread-sync.json</code>) e l'app salverà automaticamente.
            </p>

            <h3>3) Note</h3>
            <ul>
              <li>Se il testo da Internet è troppo corto, l'app riprova automaticamente con un'altra pagina.</li>
              <li>Le statistiche sono per-utente e per-esercizio, con grafici a linee nel Dashboard.</li>
            </ul>
          </div>
        </section>
      </div>
    </section>
  </main>

  <!-- Settings modal -->
  <dialog id="settingsDialog" class="dialog">
    <form method="dialog" class="dialog-form">
      <div class="dialog-head">
        <div>
          <div class="dialog-title">Impostazioni</div>
          <div class="muted small">Preferenze locali + Sync</div>
        </div>
        <button class="btn secondary" value="cancel">Chiudi</button>
      </div>

      <div class="dialog-body">
        <div class="card inner">
          <div class="card-title">Sync</div>
          <div class="muted small">Consigliato: scegli un file in una cartella sincronizzata (Nextcloud/Dropbox/OneDrive).</div>
          <div class="row gap" style="margin-top: 10px;">
            <button class="btn" id="btnConnectSync" type="button">Connetti file Sync</button>
            <button class="btn secondary" id="btnPullSync" type="button">Importa dal file</button>
            <button class="btn secondary" id="btnDisconnectSync" type="button">Disconnetti</button>
          </div>
          <div class="muted small" id="syncStatus" style="margin-top: 10px;">—</div>
        </div>

        <div class="card inner" style="margin-top: 12px;">
          <div class="card-title">UI</div>
          <div class="grid-2 tight">
            <label class="field">
              <span>Dimensione testo (pacer)</span>
              <input id="uiPacerFont" type="number" min="14" max="28" step="1" value="18" />
            </label>
            <label class="field">
              <span>Mostra debug</span>
              <input id="uiDebug" type="checkbox" />
            </label>
          </div>
        </div>
      </div>

      <div class="dialog-foot">
        <button class="btn" id="btnSaveSettings" type="button">Salva</button>
        <button class="btn secondary" value="cancel">Annulla</button>
      </div>
    </form>
  </dialog>

  <input id="fileImport" type="file" accept="application/json" hidden />
  <script type="module" src="./app.js"></script>
</body>
</html>
